/**
 * Copyright (c) 2010 Zef Hemel <zef@zef.me>
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */// Some set-up code for non-browser environments
try{window||(window={})}catch(a){window={};exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.isImmutable=function(a){return a=="id"},persistence.defineProp=function(a,b,c,d){a.__defineSetter__(b,function(a){c(a)}),a.__defineGetter__(b,function(){return d()})},persistence.set=function(a,b,c){if(persistence.isImmutable(b))throw"immutable field: "+b;a[b]=c},persistence.get=function(a,b){return arguments.length==1?a:a[b]},(function(){var a={},b={};persistence.getEntityMeta=function(){return a},persistence.trackedObjects={},persistence.objectsToRemove={},persistence.globalPropertyListeners={},persistence.queryCollectionCache={},persistence.getObjectsToRemove=function(){return this.objectsToRemove},persistence.getTrackedObjects=function(){return this.trackedObjects},persistence.entityDecoratorHooks=[],persistence.flushHooks=[],persistence.schemaSyncHooks=[],persistence.debug=true,persistence.subscribeToGlobalPropertyListener=function(a,b,c){var d=b+"__"+c;if(d in this.globalPropertyListeners){var e=this.globalPropertyListeners[d];for(var f=0;f<e.length;f++)if(e[f]===a)return;this.globalPropertyListeners[d].push(a)}else this.globalPropertyListeners[d]=[a]},persistence.propertyChanged=function(a,b,c,d){var e=a._type,f=e+"__"+b;if(f in this.globalPropertyListeners){var g=this.globalPropertyListeners[f];for(var h=0;h<g.length;h++){var i=g[h],j=a._data;j[b]=c;var k=i._filter.match(j);j[b]=d;var l=i._filter.match(j);k!=l&&i.triggerEvent("change",i,a)}}},persistence.objectRemoved=function(a){var b=a._type;if(this.queryCollectionCache[b]){var c=this.queryCollectionCache[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];e._filter.match(a)&&e.triggerEvent("change",e,a)}}};function c(b){return a[b]}persistence.getMeta=c;function d(a){this.trackedObjects={},this.objectsToRemove={},this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=a}d.prototype=persistence,persistence.Session=d,persistence.define=function(b,c){if(a[b])return e(b);var d={name:b,fields:c,hasMany:{},hasOne:{}};a[b]=d;return e(b)},persistence.isTransaction=function(a){return!a||a&&a.executeSql},persistence.isSession=function(a){return!a||a&&a.schemaSync},persistence.add=function(a){this.trackedObjects[a.id]||(this.trackedObjects[a.id]=a);return this},persistence.remove=function(a){this.objectsToRemove[a.id]||(this.objectsToRemove[a.id]=a),this.objectRemoved(a);return this},persistence.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.globalPropertyListeners={},this.queryCollectionCache={}};function e(d){if(b[d])return b[d];var e=a[d];function h(a,b){var c=argspec.getArgs(arguments,[{name:"session",optional:true,check:persistence.isSession,defaultValue:persistence},{name:"obj",optional:true,check:function(a){return a},defaultValue:{}}]);a=c.session,b=c.obj;var h=this;this.id=f(),this._new=true,this._type=d,this._dirtyProperties={},this._data={},this._data_obj={},this._session=a||persistence,this.subscribers={};for(var i in e.fields)(function(){if(e.fields.hasOwnProperty(i)){var b=i;persistence.defineProp(h,b,function(c){var d=h._data[b];h._data[b]=c,h._dirtyProperties[b]=d,h.triggerEvent("set",h,b,c),h.triggerEvent("change",h,b,c),a.propertyChanged(h,b,d,c)},function(){return h._data[b]}),h._data[i]=g(e.fields[i])}})();for(var j in e.hasOne)e.hasOne.hasOwnProperty(j)&&(function(){var b=j;persistence.defineProp(h,b,function(c){var d=h._data[b];c==null?(h._data[b]=null,h._data_obj[b]=undefined):c.id?(h._data[b]=c.id,h._data_obj[b]=c,a.add(c),a.add(h)):h._data[b]=c,h._dirtyProperties[b]=d,h.triggerEvent("set",h,b,c),h.triggerEvent("change",h,b,c)},function(){if(!h._data[b]||h._data_obj[b]!==undefined)return h._data_obj[b];if(h._data[b]&&a.trackedObjects[h._data[b]]){h._data_obj[b]=a.trackedObjects[h._data[b]];return h._data_obj[b]}throw"Property '"+b+"' with id: "+h._data[b]+" not fetched, either prefetch it or fetch it manually."})})();for(var j in e.hasMany)e.hasMany.hasOwnProperty(j)&&(function(){var b=j;e.hasMany[b].manyToMany?persistence.defineProp(h,b,function(a){if(a&&a._items){var c=a._items;for(var d=0;d<c.length;d++)persistence.get(h,b).add(c[d])}else throw"Not yet supported."},function(){if(h._data[b])return h._data[b];var c=e.hasMany[b].type.meta,d=new persistence.ManyToManyDbQueryCollection(a,c.name);d.initManyToMany(h,b),d._manyToManyFetch={table:e.hasMany[b].tableName,prop:e.name+"_"+b,inverseProp:c.name+"_"+e.hasMany[b].inverseProperty,id:h.id},h._data[b]=d;return a.uniqueQueryCollection(d)}):persistence.defineProp(h,b,function(a){if(a&&a._items){var c=a._items;for(var d=0;d<c.length;d++)persistence.get(h,b).add(c[d])}else throw"Not yet supported."},function(){if(h._data[b])return h._data[b];var c=a.uniqueQueryCollection((new persistence.DbQueryCollection(a,e.hasMany[b].type.meta.name)).filter(e.hasMany[b].inverseProperty,"=",h));h._data[b]=c;return c})})();for(var k in b)b.hasOwnProperty(k)&&persistence.set(h,k,b[k])}h.prototype=new j,h.meta=e,h.prototype.equals=function(a){return this.id==a.id},h.prototype.toJSON=function(){var a={id:this.id};for(var b in this._data)this._data.hasOwnProperty(b)&&(a[b]=this._data[b]);return a},h.prototype.selectJSON=function(a,b,c){var d=this,f=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"props",optional:false},{name:"callback",optional:false}]);a=f.tx,b=f.props,c=f.callback;if(!a){this._session.transaction(function(a){d.selectJSON(a,b,c)});return}var g={};b.forEach(function(a){var b=g,c=a.split(".");for(var d=0;d<c.length;d++){var f=c[d];if(d===c.length-1)if(f==="*"){b.id=true;for(var h in e.fields)e.fields.hasOwnProperty(h)&&(b[h]=true);for(var h in e.hasOne)e.hasOne.hasOwnProperty(h)&&(b[h]=true);for(var h in e.hasMany)e.hasMany.hasOwnProperty(h)&&(b[h]=true)}else if(f[0]==="["){f=f.substring(1,f.length-1);var i=f.split(/,\s*/);i.forEach(function(a){b[a]=true})}else b[f]=true;else b[f]=b[f]||{},b=b[f]}}),i(this,a,g,c)};function i(a,b,d,e){var f=a._session,g=[],h=c(a._type),j=h.fields;for(var k in d)d.hasOwnProperty(k)&&g.push(k);var l=[],m=[];g.forEach(function(a){d[a]===true&&!h.hasMany[a]?l.push(a):m.push(a)});var n=a._data,o={};l.forEach(function(b){b==="id"?o.id=a.id:h.hasOne[b]?o[b]={id:n[b]}:o[b]=persistence.entityValToJson(n[b],j[b])}),g=m.slice();function p(){var c=g.pop();h.hasOne[c]?a.fetch(f,b,c,function(a){i(a,b,d[c],function(a){o[c]=a,g.length>0?p():e(o)})}):h.hasMany[c]&&persistence.get(a,c).list(function(a){o[c]=[];function f(){var h=a.pop();function j(){a.length>0?f():g.length>0?p():e(o)}d[c]===true?(o[c].push({id:h.id}),j()):i(h,b,d[c],function(a){o[c].push(a),j()})}a.length>0?f():g.length>0?p():e(o)})}g.length>0?p():e(o)}h.prototype.fetch=function(a,b,c,d){var f=argspec.getArgs(arguments,[{name:"session",optional:true,check:persistence.isSession,defaultValue:persistence},{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"rel",optional:false,check:argspec.hasType("string")},{name:"callback",optional:false,check:argspec.isCallback()}]);a=f.session,b=f.tx,c=f.rel,d=f.callback;var g=this;if(!b){a.transaction(function(a){g.fetch(a,c,d)});return}this._data[c]?this._data_obj[c]?d&&d(this._data_obj[c]):e.hasOne[c].type.load(b,this._data[c],function(a){g._data_obj[c]=a,d&&d(a)}):d&&d(null)},h.prototype.markDirty=function(a){this._dirtyProperties[a]=true},h.all=function(a){a=a||persistence;return a.uniqueQueryCollection(new p(a,d))},h.fromSelectJson=function(a,b){if(!a){this._session.transaction(function(a){h.fromSelectJson(a,b)});return}typeof b==="string"&&(b=JSON.parse(b));var c=new h;for(var d in b)if(b.hasOwnProperty(d))if(d==="id")c.id=b.id;else if(e.fields[d])persistence.set(c,d,persistence.jsonToEntityVal(b[d],e.fields[d]));else if(e.hasOne[d])persistence.set(c,d,e.hasOne[d].type.fromSelectJson(a,b[d]));else if(e.hasMany[d]){var f=persistence.get(c,d),g=b[d];for(var i=0;i<g.length;i++)f.add(e.hasMany[d].type.fromSelectJson(a,g[i]))}return c},h.load=function(a,b,c,d){var e=argspec.getArgs(arguments,[{name:"session",optional:true,check:persistence.isSession,defaultValue:persistence},{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"id",optional:false,check:argspec.hasType("string")},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);h.findBy(e.session,e.tx,"id",e.id,e.callback)},h.findBy=function(a,b,c,d,e){var f=argspec.getArgs(arguments,[{name:"session",optional:true,check:persistence.isSession,defaultValue:persistence},{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"property",optional:false,check:argspec.hasType("string")},{name:"value",optional:false},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);a=f.session,b=f.tx,c=f.property,d=f.value,e=f.callback;if(c==="id"&&d in a.trackedObjects){e(a.trackedObjects[d]);return}if(!b){a.transaction(function(b){h.findBy(a,b,c,d,e)});return}h.all(a).filter(c,"=",d).one(b,function(a){e(a)})},h.hasMany=function(a,b,c){var d=b.meta;if(d.hasMany[c]){var f=e.name+"_"+a+"_"+d.name,g=d.name+"_"+c+"_"+e.name;f>g&&(f=g),e.hasMany[a]={type:b,inverseProperty:c,manyToMany:true,tableName:f},d.hasMany[c]={type:h,inverseProperty:a,manyToMany:true,tableName:f},delete e.hasOne[a]}else e.hasMany[a]={type:b,inverseProperty:c},d.hasOne[c]={type:h,inverseProperty:a}},h.hasOne=function(a,b){e.hasOne[a]={type:b}};var k=persistence.entityDecoratorHooks;for(var l=0;l<k.length;l++)k[l](h);b[d]=h;return h}persistence.jsonToEntityVal=function(a,b){if(b)switch(b){case"DATE":return new Date(a*1e3);break;default:return a}else return a},persistence.entityValToJson=function(a,b){if(b)switch(b){case"DATE":return a?Math.round(a.getTime()/1e3):null;break;default:return a}else return a},persistence.dump=function(a,c,d){var e=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"entities",optional:true,check:function(a){return a&&a.length},defaultValue:null},{name:"callback",optional:false,check:argspec.isCallback(),defaultValue:function(){}}]);a=e.tx,c=e.entities,d=e.callback;if(!c){c=[];for(var f in b)b.hasOwnProperty(f)&&c.push(b[f])}var g=0,h={};for(var i=0;i<c.length;i++)(function(){var b=c[i];b.all().list(a,function(a){h[b.meta.name]=a.map(function(a){var c={},d=b.meta.fields;for(var e in d)d.hasOwnProperty(e)&&(c[e]=persistence.entityValToJson(a._data[e],d[e]));var f=b.meta.hasOne;for(var g in f)f.hasOwnProperty(g)&&(c[g]=a._data[g]);c.id=a.id;return c}),g++,g===c.length&&d(h)})})()},persistence.load=function(a,b,c){var d=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"dump",optional:false},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);a=d.tx,b=d.dump,c=d.callback;var f=0;for(var g in b)if(b.hasOwnProperty(g)){var h=e(g),i=h.meta.fields,j=b[g];for(var k=0;k<j.length;k++){var l=j[k],m=new h;for(var n in l)l.hasOwnProperty(n)&&(persistence.isImmutable(n)?m[n]=l[n]:persistence.set(m,n,persistence.jsonToEntityVal(l[n],i[n])));this.add(m)}}this.flush(a,c)},persistence.dumpToJson=function(a,b,c){var d=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"entities",optional:true,check:function(a){return a&&a.length},defaultValue:null},{name:"callback",optional:false,check:argspec.isCallback(),defaultValue:function(){}}]);a=d.tx,b=d.entities,c=d.callback,this.dump(a,b,function(a){c(JSON.stringify(a))})},persistence.loadFromJson=function(a,b,c){var d=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"jsonDump",optional:false},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);a=d.tx,b=d.jsonDump,c=d.callback,this.load(a,JSON.parse(b),c)};function f(){var a=[],b="0123456789ABCDEF";for(var c=0;c<32;c++)a[c]=b.substr(Math.floor(Math.random()*16),1);a[12]="4",a[16]=b.substr(a[16]&3|8,1);var d=a.join("");return d}function g(a){switch(a){case"TEXT":return"";case"BOOL":return false;default:return a.indexOf("INT")!==-1?0:a.indexOf("CHAR")!==-1?"":null}}function h(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];if(e.equals&&e.equals(b))return true;if(e===b)return true}return false}function i(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];e.equals&&e.equals(b)?a.splice(d,1):e===b&&a.splice(d,1)}}function j(){this.subscribers={}}j.prototype.addEventListener=function(a,b){if(typeof a=="object"){var c=a;for(var d=0;d<c.length;d++){var a=c[d];this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b)}}else this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b)},j.prototype.removeEventListener=function(a,b){var c=this.subscribers[a];for(var d=0;d<c.length;d++)if(c[d]==b){this.subscribers[a].splice(d,1);return true}return false},j.prototype.triggerEvent=function(a){if(!this.subscribers[a])return;for(var b in this.subscribers[a])this.subscribers[a].hasOwnProperty(b)&&this.subscribers[a][b].apply(null,arguments)};function k(){}k.prototype.match=function(a){return true},k.prototype.makeFit=function(a){},k.prototype.makeNotFit=function(a){},k.prototype.toUniqueString=function(){return"NULL"};function l(a,b){this.left=a,this.right=b}l.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)},l.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},l.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},l.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()};function m(a,b,c){this.property=a,this.operator=b,this.value=c}m.prototype.match=function(a){var b=this.value,c=persistence.get(a,this.property);b&&b.getTime&&(b=Math.round(b.getTime()/1e3)*1e3,c&&c.getTime&&(c=Math.round(c.getTime()/1e3)*1e3));switch(this.operator){case"=":return c===b;break;case"!=":return c!==b;break;case"<":return c<b;break;case"<=":return c<=b;break;case">":return c>b;break;case">=":return c>=b;break;case"in":return h(b,c);break;case"not in":return!h(b,c)}},m.prototype.makeFit=function(a){if(this.operator==="=")persistence.set(a,this.property,this.value);else throw"Sorry, can't perform makeFit for other filters than ="},m.prototype.makeNotFit=function(a){if(this.operator==="=")persistence.set(a,this.property,null);else throw"Sorry, can't perform makeNotFit for other filters than ="},m.prototype.toUniqueString=function(){var a=this.value;a&&a._type&&(a=a.id);return this.property+this.operator+a},persistence.NullFilter=k,persistence.AndFilter=l,persistence.PropertyFilter=m,persistence.uniqueQueryCollection=function(a){var b=a._entityName;this.queryCollectionCache[b]||(this.queryCollectionCache[b]={});var c=a.toUniqueString();this.queryCollectionCache[b][c]||(this.queryCollectionCache[b][c]=a);return this.queryCollectionCache[b][c]};function n(){}n.prototype=new j,n.prototype.persistQueries=function(){return[]},n.prototype.init=function(a,b,c){this._filter=new k,this._orderColumns=[],this._prefetchFields=[],this._entityName=b,this._constructor=c,this._limit=-1,this._skip=0,this._reverse=false,this._session=a||persistence,this.subscribers={}},n.prototype.toUniqueString=function(){var a=this._constructor.name+": "+this._entityName;a+="|Filter:";var b=[];a+=this._filter.toUniqueString(),a+="|Values:";for(var c=0;c<b.length;c++)a+=b+"|^|";a+="|Order:";for(var c=0;c<this._orderColumns.length;c++){var d=this._orderColumns[c];a+=d[0]+", "+d[1]}a+="|Prefetch:";for(var c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];a+="|Limit:",a+=this._limit,a+="|Skip:",a+=this._skip,a+="|Reverse:",a+=this._reverse;return a},n.prototype.clone=function(a){var b=new this._constructor(this._session,this._entityName);b._filter=this._filter,b._prefetchFields=this._prefetchFields.slice(0),b._orderColumns=this._orderColumns.slice(0),b._limit=this._limit,b._skip=this._skip,b._reverse=this._reverse;if(a){var c={};for(var d in this.subscribers)this.subscribers.hasOwnProperty(d)&&(c[d]=this.subscribers[d].slice(0));b.subscribers=c}else b.subscribers=this.subscribers;return b},n.prototype.filter=function(a,b,c){var d=this.clone(true);d._filter=new l(this._filter,new m(a,b,c));var e=this._session;d=e.uniqueQueryCollection(d),e.subscribeToGlobalPropertyListener(d,this._entityName,a);return e.uniqueQueryCollection(d)},n.prototype.order=function(a,b){b=b===undefined?true:b;var c=this.clone();c._orderColumns.push([a,b]);return this._session.uniqueQueryCollection(c)},n.prototype.limit=function(a){var b=this.clone();b._limit=a;return this._session.uniqueQueryCollection(b)},n.prototype.skip=function(a){var b=this.clone();b._skip=a;return this._session.uniqueQueryCollection(b)},n.prototype.reverse=function(){var a=this.clone();a._reverse=true;return this._session.uniqueQueryCollection(a)},n.prototype.prefetch=function(a){var b=this.clone();b._prefetchFields.push(a);return this._session.uniqueQueryCollection(b)},n.prototype.add=function(a){if(!a.id||!a._type)throw"Cannot add object of non-entity type onto collection.";this._session.add(a),this._filter.makeFit(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},n.prototype.remove=function(a){if(!a.id||!a._type)throw"Cannot remove object of non-entity type from collection.";this._filter.makeNotFit(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)};function o(a,b){this.init(a,b,o)}n.prototype.each=function(a,b){var c=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"eachFn",optional:true,check:argspec.isCallback()}]);a=c.tx,b=c.eachFn,this.list(a,function(a){for(var c=0;c<a.length;c++)b(a[c])})},n.prototype.forEach=n.prototype.each,n.prototype.one=function(a,b){var c=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"oneFn",optional:false,check:argspec.isCallback()}]);a=c.tx,b=c.oneFn;var d=this;this.limit(1).list(a,function(a){a.length===0?b(null):b(a[0])})},o.prototype=new n;function p(a,b){this.init(a,b,p)}p.prototype=new o,p.prototype.add=function(a){this._session.add(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},p.prototype.remove=function(a){this._session.remove(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)};function q(a,b){this.init(a,b,persistence.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}q.prototype=new o,q.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},q.prototype.add=function(a){h(this._localAdded,a)||(this._session.add(a),this._localAdded.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},q.prototype.clone=function(){var a=o.prototype.clone.call(this);a._localAdded=this._localAdded,a._localRemoved=this._localRemoved,a._obj=this._obj,a._coll=this._coll;return a},q.prototype.remove=function(a){h(this._localAdded,a)?i(this._localAdded,a):h(this._localRemoved,a)||this._localRemoved.push(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)};function r(a){this.init(persistence,null,r),this._items=a||[]}r.prototype=new n,r.prototype.clone=function(){var a=o.prototype.clone.call(this);a._items=this._items;return a},r.prototype.add=function(a){h(this._items,a)||(this._items.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},r.prototype.remove=function(a){var b=this._items;for(var c=0;c<b.length;c++)b[c]===a&&(this._items.splice(c,1),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a))},r.prototype.list=function(a,b){var c=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback()}]);b=c.callback;if(!b||b.executeSql)b=arguments[1];var d=this._items.slice(0),e=this,f=[];for(var g=0;g<d.length;g++)this._filter.match(d[g])&&f.push(d[g]);f.sort(function(a,b){for(var c=0;c<e._orderColumns.length;c++){var d=e._orderColumns[c][0],f=e._orderColumns[c][1],g=persistence.get(a,d),h=persistence.get(b,d);if(g<h)return f?-1:1;if(g>h)return f?1:-1}return 0}),this._skip&&f.splice(0,this._skip),this._limit>-1&&(f=f.slice(0,this._limit)),this._reverse&&f.reverse();if(b)b(f);else return f},r.prototype.destroyAll=function(a){if(!a||a.executeSql)a=arguments[1];this._items=[],a&&a()},r.prototype.count=function(a,b){var c=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback()}]);a=c.tx,b=c.callback;var d=this.list();if(b)b(d.length);else return d.length},persistence.QueryCollection=n,persistence.DbQueryCollection=o,persistence.ManyToManyDbQueryCollection=q,persistence.LocalQueryCollection=r,persistence.Observable=j})();try{exports.persistence=persistence}catch(a){}var argspec={};(function(){argspec.getArgs=function(a,b){var c=0,d=0,e={};while(d<b.length){var f=b[d],g=a[c];if(f.optional)g!==undefined&&f.check(g)?(e[f.name]=g,c++,d++):(f.defaultValue!==undefined&&(e[f.name]=f.defaultValue),d++);else{if(f.check&&!f.check(g))throw"Invalid value for argument: "+f.name+" Value: "+g;e[f.name]=g,d++,c++}}return e},argspec.hasProperty=function(a){return function(b){return b&&b[a]!==undefined}},argspec.hasType=function(a){return function(b){return typeof b===a}},argspec.isCallback=function(){return function(a){return a&&a.apply}}})(),persistence.argspec=argspec,typeof JSON==="undefined"&&(JSON={}),JSON.stringify||(function(){function f(a){return a<10?"0"+a:a}typeof Date.prototype.toJSON!=="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\"":"\\\"","\\":"\\\\"},rep;function quote(a){escapable.lastIndex=0;return escapable.test(a)?"\""+a.replace(escapable,function(a){var b=meta[a];return typeof b==="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+"\"":"\""+a+"\""}function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i==="object"&&typeof i.toJSON==="function"&&(i=i.toJSON(a)),typeof rep==="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g;return e}if(rep&&typeof rep==="object"){f=rep.length;for(c=0;c<f;c+=1)d=rep[c],typeof d==="string"&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g;return e}}typeof JSON.stringify!=="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c==="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c==="string"&&(indent=c);rep=b;if(b&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw new Error("JSON.stringify");return str("",{"":a})}),typeof JSON.parse!=="function"&&(JSON.parse=function(text,reviver){var j;function walk(a,b){var c,d,e=a[b];if(e&&typeof e==="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})})()