/**
 * Copyright (c) 2010 Zef Hemel <zef@zef.me>
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */function createPersistence(){var a={};a.isImmutable=function(a){return a=="id"},a.defineProp=function(a,b,c,d){a.__defineSetter__(b,function(a){c(a)}),a.__defineGetter__(b,function(){return d()})},a.set=function(b,c,d){if(a.isImmutable(c))throw new Error("immutable field: "+c);b[c]=d},a.get=function(a,b){return arguments.length==1?a:a[b]},function(){function v(b){this.init(a,null,v),this._items=b||[]}function u(b,c){this.init(b,c,a.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function t(a,b){this.init(a,b,t)}function s(a,b){this.init(a,b,s)}function r(){}function q(a,b,c){this.property=a,this.operator=b.toLowerCase(),this.value=c}function p(a,b){this.left=a,this.right=b}function o(a,b){this.left=a,this.right=b}function n(){}function m(){this.subscribers={}}function l(a,b,c){this.obj=a,this.eventType=b,this.fn=c}function k(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];e.equals&&e.equals(b)?a.splice(d,1):e===b&&a.splice(d,1)}}function j(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];if(e.equals&&e.equals(b))return!0;if(e===b)return!0}return!1}function i(b){if(a.typeMapper&&a.typeMapper.defaultValue)return a.typeMapper.defaultValue(b);switch(b){case"TEXT":return"";case"BOOL":return!1;default:return b.indexOf("INT")!==-1?0:b.indexOf("CHAR")!==-1?"":null}}function h(){if(a.typeMapper&&a.typeMapper.newUuid)return a.typeMapper.newUuid();var b=[],c="0123456789ABCDEF";for(var d=0;d<32;d++)b[d]=c.substr(Math.floor(Math.random()*16),1);b[12]="4",b[16]=c.substr(b[16]&3|8,1);var e=b.join("");return e}function g(f){function k(b,c,d,f){var g=b._session,h=[],i=e(b._type),j=i.fields;for(var l in d)d.hasOwnProperty(l)&&h.push(l);var m=[],n=[];h.forEach(function(a){d[a]!==!0||i.hasMany[a]?n.push(a):m.push(a)});var o=b._data,p={};m.forEach(function(c){c==="id"?p.id=b.id:i.hasOne[c]?p[c]=o[c]?{id:o[c]}:null:p[c]=a.entityValToJson(o[c],j[c])}),h=n.slice(),a.asyncForEach(h,function(e,f){i.hasOne[e]?b.fetch(g,c,e,function(a){a?k(a,c,d[e],function(a){p[e]=a,f()}):(p[e]=null,f())}):i.hasMany[e]&&a.get(b,e).list(function(b){p[e]=[],a.asyncForEach(b,function(a,f){var a=b.pop();d[e]===!0?(p[e].push({id:a.id}),f()):k(a,c,d[e],function(a){p[e].push(a),f()})},f)})},function(){f(p)})}function j(c,d,e){var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"obj",optional:!0,check:function(a){return a},defaultValue:{}}]);if(h.isMixin)throw new Error("Cannot instantiate mixin");c=g.session,d=g.obj;var j=this;this.id=a.createUUID(),this._new=!0,this._type=f,this._dirtyProperties={},this._data={},this._data_obj={},this._session=c||a,this.subscribers={};for(var k in h.fields)(function(){if(h.fields.hasOwnProperty(k)){var b=k;a.defineProp(j,b,function(a){var d=j._data[b];if(d!==a||d&&a&&d.getTime&&a.getTime)j._data[b]=a,j._dirtyProperties[b]=d,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a),c.propertyChanged(j,b,d,a)},function(){return j._data[b]}),j._data[k]=i(h.fields[k])}})();for(var l in h.hasOne)h.hasOne.hasOwnProperty(l)&&function(){var b=l,d=h.hasOne[l].type.meta.isMixin?b+"_class":null;a.defineProp(j,b,function(a){var e=j._data[b];a==null?(j._data[b]=null,j._data_obj[b]=undefined,d&&(j[d]="")):a.id?(j._data[b]=a.id,j._data_obj[b]=a,d&&(j[d]=a._type),c.add(a),c.add(j)):j._data[b]=a,j._dirtyProperties[b]=e,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a)},function(){if(j._data[b]){if(j._data_obj[b]!==undefined)return j._data_obj[b];if(j._data[b]&&c.trackedObjects[j._data[b]]){j._data_obj[b]=c.trackedObjects[j._data[b]];return j._data_obj[b]}throw new Error("Property '"+b+"' with id: "+j._data[b]+" not fetched, either prefetch it or fetch it manually.")}return null})}();for(var l in h.hasMany)h.hasMany.hasOwnProperty(l)&&function(){var b=l;h.hasMany[b].manyToMany?a.defineProp(j,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");var d=c._items;for(var e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){if(j._data[b])return j._data[b];var d=h.hasMany[b],e=d.type.meta,f=e.hasMany[d.inverseProperty],g=d.mixin?d.mixin.meta.name:h.name,i=f.mixin?f.mixin.meta.name:e.name,k=new a.ManyToManyDbQueryCollection(c,e.name);k.initManyToMany(j,b),k._manyToManyFetch={table:d.tableName,prop:g+"_"+b,inverseProp:i+"_"+d.inverseProperty,id:j.id},j._data[b]=k;return c.uniqueQueryCollection(k)}):a.defineProp(j,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");var d=c._items;for(var e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){if(j._data[b])return j._data[b];var d=c.uniqueQueryCollection((new a.DbQueryCollection(c,h.hasMany[b].type.meta.name)).filter(h.hasMany[b].inverseProperty,"=",j));j._data[b]=d;return d})}();for(var m in d)d.hasOwnProperty(m)&&a.set(j,m,d[m])}if(d[f])return d[f];var h=c[f];j.prototype=new m,j.meta=h,j.prototype.equals=function(a){return this.id==a.id},j.prototype.toJSON=function(){var a={id:this.id};for(var b in this._data)this._data.hasOwnProperty(b)&&(typeof this._data[b]=="object"&&this._data[b]!=null?this._data[b].toJSON!=undefined&&(a[b]=this._data[b].toJSON()):a[b]=this._data[b]);return a},j.prototype.selectJSON=function(c,d,e){var f=this,g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);c=g.tx,d=g.props,e=g.callback;if(c){var i={};d.forEach(function(a){var b=i,c=a.split(".");for(var d=0;d<c.length;d++){var e=c[d];if(d===c.length-1)if(e==="*"){b.id=!0;for(var f in h.fields)h.fields.hasOwnProperty(f)&&(b[f]=!0);for(var f in h.hasOne)h.hasOne.hasOwnProperty(f)&&(b[f]=!0);for(var f in h.hasMany)h.hasMany.hasOwnProperty(f)&&(b[f]=!0)}else if(e[0]==="["){e=e.substring(1,e.length-1);var g=e.split(/,\s*/);g.forEach(function(a){b[a]=!0})}else b[e]=!0;else b[e]=b[e]||{},b=b[e]}}),k(this,c,i,e)}else this._session.transaction(function(a){f.selectJSON(a,d,e)})},j.prototype.fetch=function(c,d,e,f){var i=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:b.hasType("string")},{name:"callback",optional:!1,check:b.isCallback()}]);c=i.session,d=i.tx,e=i.rel,f=i.callback;var j=this;if(d)if(this._data[e])if(this._data_obj[e])f&&f(this._data_obj[e]);else{var k=h.hasOne[e].type;k.meta.isMixin&&(k=g(this._data[e+"_class"])),k.load(c,d,this._data[e],function(a){j._data_obj[e]=a,f&&f(a)})}else f&&f(null);else c.transaction(function(a){j.fetch(c,a,e,f)})},j.prototype.markDirty=function(a){this._dirtyProperties[a]=!0},j.all=function(b){b=b||a;return b.uniqueQueryCollection(new t(b,f))},j.fromSelectJSON=function(c,d,e,f){function i(b){b||(b=new j,e.id&&(b.id=e.id)),c.add(b);var g=[];for(var i in e)if(e.hasOwnProperty(i)){if(i==="id")continue;h.fields[i]?a.set(b,i,a.jsonToEntityVal(e[i],h.fields[i])):(h.hasOne[i]||h.hasMany[i])&&g.push(i)}a.asyncForEach(g,function(f,g){if(h.hasOne[f])h.hasOne[f].type.fromSelectJSON(c,d,e[f],function(c){a.set(b,f,c),g()});else if(h.hasMany[f]){var i=a.get(b,f),j=e[f].slice(0),k=h.hasMany[f].type;i.list(d,function(b){a.asyncForEach(j,function(a,e){k.fromSelectJSON(c,d,a,function(a){for(var c=0;c<b.length;c++)if(b[c].id===a.id){e();return}i.add(a),e()})},function(){g()})})}},function(){f(b)})}var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:b.isCallback()}]);c=g.session,d=g.tx,e=g.jsonObj,f=g.callback;if(d){typeof e==="string"&&(e=JSON.parse(e));if(!e){f(null);return}e.id?j.load(c,d,e.id,i):i(new j)}else c.transaction(function(a){j.fromSelectJSON(c,a,e,f)})},j.load=function(c,d,e,f){var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"id",optional:!1,check:b.hasType("string")},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);j.findBy(g.session,g.tx,"id",g.id,g.callback)},j.findBy=function(c,d,e,f,g){var h=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"property",optional:!1,check:b.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=h.session,d=h.tx,e=h.property,f=h.value,g=h.callback;if(e==="id"&&f in c.trackedObjects)g(c.trackedObjects[f]);else{if(!d){c.transaction(function(a){j.findBy(c,a,e,f,g)});return}j.all(c).filter(e,"=",f).one(d,function(a){g(a)})}},j.index=function(a,b){var c=b||{};typeof a=="string"&&(a=[a]),c.columns=a,h.indexes.push(c)},j.hasMany=function(b,c,d){var e=c.meta;if(e.hasMany[d]){var f=h.name+"_"+b+"_"+e.name,g=e.name+"_"+d+"_"+h.name;f>g&&(f=g),h.hasMany[b]={type:c,inverseProperty:d,manyToMany:!0,tableName:f},e.hasMany[d]={type:j,inverseProperty:b,manyToMany:!0,tableName:f},delete h.hasOne[b],delete h.fields[b+"_class"]}else h.hasMany[b]={type:c,inverseProperty:d},e.hasOne[d]={type:j,inverseProperty:b},h.isMixin&&(e.fields[d+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},j.hasOne=function(b,c){h.hasOne[b]={type:c},c.meta.isMixin&&(h.fields[b+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},j.is=function(a){var b=a.meta;if(!b.isMixin)throw new Error("not a mixin: "+a);a.meta.mixedIns=a.meta.mixedIns||[],a.meta.mixedIns.push(h);for(var c in b.fields)b.fields.hasOwnProperty(c)&&(h.fields[c]=b.fields[c]);for(var d in b.hasOne)b.hasOne.hasOwnProperty(d)&&(h.hasOne[d]=b.hasOne[d]);for(var d in b.hasMany)b.hasMany.hasOwnProperty(d)&&(b.hasMany[d].mixin=a,h.hasMany[d]=b.hasMany[d])};var l=a.entityDecoratorHooks;for(var n=0;n<l.length;n++)l[n](j);d[f]=j;return j}function f(a){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=a}function e(a){return c[a]}var c={},d={};a.getEntityMeta=function(){return c},a.trackedObjects={},a.objectsToRemove={},a.objectsRemoved=[],a.globalPropertyListeners={},a.queryCollectionCache={},a.getObjectsToRemove=function(){return this.objectsToRemove},a.getTrackedObjects=function(){return this.trackedObjects},a.entityDecoratorHooks=[],a.flushHooks=[],a.schemaSyncHooks=[],a.debug=!0,a.subscribeToGlobalPropertyListener=function(a,b,c){var d=b+"__"+c;if(d in this.globalPropertyListeners){var e=this.globalPropertyListeners[d];for(var f=0;f<e.length;f++)if(e[f]===a)return;this.globalPropertyListeners[d].push(a)}else this.globalPropertyListeners[d]=[a]},a.unsubscribeFromGlobalPropertyListener=function(a,b,c){var d=b+"__"+c,e=this.globalPropertyListeners[d];for(var f=0;f<e.length;f++)if(e[f]===a){e.splice(f,1);return}},a.propertyChanged=function(a,b,c,d){if(this.trackedObjects[a.id]){var e=a._type,f=e+"__"+b;if(f in this.globalPropertyListeners){var g=this.globalPropertyListeners[f];for(var h=0;h<g.length;h++){var i=g[h],j=a._data;j[b]=c;var k=i._filter.match(j);j[b]=d;var l=i._filter.match(j);k!=l&&i.triggerEvent("change",i,a)}}}},a.objectRemoved=function(a){var b=a._type;if(this.queryCollectionCache[b]){var c=this.queryCollectionCache[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];e._filter.match(a)&&e.triggerEvent("change",e,a)}}},a.getMeta=e,f.prototype=a,a.Session=f,a.define=function(a,b){if(c[a])return g(a);var d={name:a,fields:b,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};c[a]=d;return g(a)},a.isDefined=function(a){return!!c[a]},a.defineMixin=function(a,b){var c=this.define(a,b);c.meta.isMixin=!0;return c},a.isTransaction=function(a){return!a||a&&a.executeSql},a.isSession=function(a){return!a||a&&a.schemaSync},a.add=function(a){if(a){if(!this.trackedObjects[a.id]){this.trackedObjects[a.id]=a;if(a._new)for(var b in a._data)a._data.hasOwnProperty(b)&&this.propertyChanged(a,b,undefined,a._data[b])}return this}},a.remove=function(a){this.objectsToRemove[a.id]||(this.objectsToRemove[a.id]=a),this.objectsRemoved.push({id:a.id,entity:a._type}),this.objectRemoved(a);return this},a.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={}},a.asyncForEach=function(a,b,c){function d(){var e=a.pop();b(e,function(b,e){a.length>0?d():c(b,e)})}a=a.slice(0),a.length>0?d():c()},a.asyncParForEach=function(a,b,c){var d=0;a.length===0&&c();for(var e=0;e<a.length;e++)b(a[e],function(b,e){d++,d===a.length&&c(b,e)})},a.jsonToEntityVal=function(a,b){if(!b)return a;switch(b){case"DATE":return new Date(a*1e3);default:return a}},a.entityValToJson=function(a,b){if(!b)return a;switch(b){case"DATE":if(a){a=new Date(a);return Math.round(a.getTime()/1e3)}return null;default:return a}},a.dump=function(c,e,f){var g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return!a||a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=g.tx,e=g.entities,f=g.callback;if(!e){e=[];for(var h in d)d.hasOwnProperty(h)&&e.push(d[h])}var i={};a.asyncParForEach(e,function(b,d){b.all().list(c,function(e){var f=[];a.asyncParForEach(e,function(d,e){var g={},h=b.meta.fields;for(var i in h)h.hasOwnProperty(i)&&(g[i]=a.entityValToJson(d._data[i],h[i]));var j=b.meta.hasOne;for(var k in j)j.hasOwnProperty(k)&&(g[k]=d._data[k]);var l=b.meta.hasMany,m=[];for(var n in l)l.hasOwnProperty(n)&&m.push(n);a.asyncParForEach(m,function(b,e){var f=a.get(d,b);f.list(c,function(a){g[b]=a.map(function(a){return a.id}),e()})},function(){g.id=d.id,f.push(g),e()})},function(){i[b.meta.name]=f,d()})})},function(){f(i)})},a.load=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.dump,e=f.callback;var h=0,i=[],j=this;for(var k in d)if(d.hasOwnProperty(k)){var l=g(k),m=l.meta.fields,n=d[k];for(var o=0;o<n.length;o++){var p=n[o],q=new l;q.id=p.id;for(var r in p)if(p.hasOwnProperty(r))if(a.isImmutable(r))q[r]=p[r];else if(l.meta.hasMany[r]){var s=l.meta.hasMany[r];if(s.manyToMany&&l.meta.name<s.type.meta.name)continue;var t=a.get(q,r);p[r].length>0&&p[r].forEach(function(a){i.push({Entity:l,coll:t,id:a})})}else a.set(q,r,a.jsonToEntityVal(p[r],m[r]));this.add(q)}}j.flush(c,function(){a.asyncForEach(i,function(a,b){a.Entity.load(j,c,a.id,function(c){a.coll.add(c),b()})},function(){j.flush(c,e)})})},a.dumpToJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.entities,e=f.callback,this.dump(c,d,function(a){e(JSON.stringify(a))})},a.loadFromJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.jsonDump,e=f.callback,this.load(c,JSON.parse(d),e)},a.createUUID=h,l.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},m.prototype.addEventListener=function(a,b){this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b);return new l(this,a,b)},m.prototype.removeEventListener=function(a,b){var c=this.subscribers[a];for(var d=0;d<c.length;d++)if(c[d]==b){this.subscribers[a].splice(d,1);return!0}return!1},m.prototype.triggerEvent=function(a){if(this.subscribers[a])for(var b in this.subscribers[a])this.subscribers[a].hasOwnProperty(b)&&this.subscribers[a][b].apply(null,arguments)},n.prototype.match=function(a){return!0},n.prototype.makeFit=function(a){},n.prototype.makeNotFit=function(a){},n.prototype.toUniqueString=function(){return"NULL"},n.prototype.subscribeGlobally=function(){},n.prototype.unsubscribeGlobally=function(){},o.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)},o.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},o.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},o.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},o.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},o.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},p.prototype.match=function(a){return this.left.match(a)||this.right.match(a)},p.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},p.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},p.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},p.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},p.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},q.prototype.match=function(b){var c=this.value,d=a.get(b,this.property);c&&c.getTime&&(c=Math.round(c.getTime()/1e3)*1e3,d&&d.getTime&&(d=Math.round(d.getTime()/1e3)*1e3));switch(this.operator){case"=":return d===c;case"!=":return d!==c;case"<":return d<c;case"<=":return d<=c;case">":return d>c;case">=":return d>=c;case"in":return j(c,d);case"not in":return!j(c,d)}},q.prototype.makeFit=function(b){if(this.operator==="=")a.set(b,this.property,this.value);else throw new Error("Sorry, can't perform makeFit for other filters than =")},q.prototype.makeNotFit=function(b){if(this.operator==="=")a.set(b,this.property,null);else throw new Error("Sorry, can't perform makeNotFit for other filters than =")},q.prototype.subscribeGlobally=function(b,c){a.subscribeToGlobalPropertyListener(b,c,this.property)},q.prototype.unsubscribeGlobally=function(b,c){a.unsubscribeFromGlobalPropertyListener(b,c,this.property)},q.prototype.toUniqueString=function(){var a=this.value;a&&a._type&&(a=a.id);return this.property+this.operator+a},a.NullFilter=n,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q,a.uniqueQueryCollection=function(a){var b=a._entityName;if(a._items)return a;this.queryCollectionCache[b]||(this.queryCollectionCache[b]={});var c=a.toUniqueString();this.queryCollectionCache[b][c]||(this.queryCollectionCache[b][c]=a);return this.queryCollectionCache[b][c]},r.prototype=new m,r.prototype.oldAddEventListener=r.prototype.addEventListener,r.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},r.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},r.prototype.addEventListener=function(a,b){var c=this,d=this.oldAddEventListener(a,b);this.subscribers[a].length===1&&this.setupSubscriptions(),d.oldUnsubscribe=d.unsubscribe,d.unsubscribe=function(){this.oldUnsubscribe(),c.subscribers[a].length===0&&c.teardownSubscriptions()};return d},r.prototype.persistQueries=function(){return[]},r.prototype.init=function(b,c,d){this._filter=new n,this._orderColumns=[],this._prefetchFields=[],this._entityName=c,this._constructor=d,this._limit=-1,this._skip=0,this._reverse=!1,this._session=b||a,this.subscribers={}},r.prototype.toUniqueString=function(){var a=this._constructor.name+": "+this._entityName;a+="|Filter:";var b=[];a+=this._filter.toUniqueString(),a+="|Values:";for(var c=0;c<b.length;c++)a+=b+"|^|";a+="|Order:";for(var c=0;c<this._orderColumns.length;c++){var d=this._orderColumns[c];a+=d[0]+", "+d[1]}a+="|Prefetch:";for(var c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];a+="|Limit:",a+=this._limit,a+="|Skip:",a+=this._skip,a+="|Reverse:",a+=this._reverse;return a},r.prototype.clone=function(a){var b=new this._constructor(this._session,this._entityName);b._filter=this._filter,b._prefetchFields=this._prefetchFields.slice(0),b._orderColumns=this._orderColumns.slice(0),b._limit=this._limit,b._skip=this._skip,b._reverse=this._reverse;if(a){var c={};for(var d in this.subscribers)this.subscribers.hasOwnProperty(d)&&(c[d]=this.subscribers[d].slice(0));b.subscribers=c}else b.subscribers=this.subscribers;return b},r.prototype.filter=function(a,b,c){var d=this.clone(!0);d._filter=new o(this._filter,new q(a,b,c));var e=this._session;d=e.uniqueQueryCollection(d);return e.uniqueQueryCollection(d)},r.prototype.or=function(a){var b=this.clone(!0);b._filter=new p(this._filter,a);return this._session.uniqueQueryCollection(b)},r.prototype.and=function(a){var b=this.clone(!0);b._filter=new o(this._filter,a);return this._session.uniqueQueryCollection(b)},r.prototype.order=function(a,b){b=b===undefined?!0:b;var c=this.clone();c._orderColumns.push([a,b]);return this._session.uniqueQueryCollection(c)},r.prototype.limit=function(a){var b=this.clone();b._limit=a;return this._session.uniqueQueryCollection(b)},r.prototype.skip=function(a){var b=this.clone();b._skip=a;return this._session.uniqueQueryCollection(b)},r.prototype.reverse=function(){var a=this.clone();a._reverse=!0;return this._session.uniqueQueryCollection(a)},r.prototype.prefetch=function(a){var b=this.clone();b._prefetchFields.push(a);return this._session.uniqueQueryCollection(b)},r.prototype.selectJSON=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),h=this._session,i=this;c=f.tx,d=f.props,e=f.callback;if(c){var j=g(this._entityName);this.list(function(b){var f=[];a.asyncForEach(b,function(a,b){a.selectJSON(c,d,function(a){f.push(a),b()})},function(){e(f)})})}else h.transaction(function(a){i.selectJSON(a,d,e)})},r.prototype.add=function(a){if(!a.id||!a._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(a),this._filter.makeFit(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},r.prototype.remove=function(a){if(!a.id||!a._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},r.prototype.each=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.eachFn,this.list(c,function(a){for(var b=0;b<a.length;b++)d(a[b])})},r.prototype.forEach=r.prototype.each,r.prototype.one=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:b.isCallback()}]);c=e.tx,d=e.oneFn;var f=this;this.limit(1).list(c,function(a){a.length===0?d(null):d(a[0])})},s.prototype=new r,t.prototype=new s,t.prototype.add=function(a){this._session.add(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},t.prototype.remove=function(a){this._session.remove(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},u.prototype=new s,u.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},u.prototype.add=function(a){j(this._localAdded,a)||(this._session.add(a),this._localAdded.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},u.prototype.clone=function(){var a=s.prototype.clone.call(this);a._localAdded=this._localAdded,a._localRemoved=this._localRemoved,a._obj=this._obj,a._coll=this._coll;return a},u.prototype.remove=function(a){j(this._localAdded,a)?k(this._localAdded,a):j(this._localRemoved,a)||this._localRemoved.push(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},v.prototype=new r,v.prototype.clone=function(){var a=s.prototype.clone.call(this);a._items=this._items;return a},v.prototype.add=function(a){j(this._items,a)||(this._session.add(a),this._items.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},v.prototype.remove=function(a){var b=this._items;for(var c=0;c<b.length;c++)b[c]===a&&(this._items.splice(c,1),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a))},v.prototype.list=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);d=e.callback;if(!d||d.executeSql)d=arguments[1];var f=this._items.slice(0),g=this,h=[];for(var i=0;i<f.length;i++)this._filter.match(f[i])&&h.push(f[i]);h.sort(function(b,c){for(var d=0;d<g._orderColumns.length;d++){var e=g._orderColumns[d][0],f=g._orderColumns[d][1],h=a.get(b,e),i=a.get(c,e);if(h<i)return f?-1:1;if(h>i)return f?1:-1}return 0}),this._skip&&h.splice(0,this._skip),this._limit>-1&&(h=h.slice(0,this._limit)),this._reverse&&h.reverse();if(d)d(h);else return h},v.prototype.destroyAll=function(a){if(!a||a.executeSql)a=arguments[1];this._items=[],this.triggerEvent("change",this),a&&a()},v.prototype.count=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.callback;var f=this.list();if(d)d(f.length);else return f.length},a.QueryCollection=r,a.DbQueryCollection=s,a.ManyToManyDbQueryCollection=u,a.LocalQueryCollection=v,a.Observable=m,a.Subscription=l,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q}();var b={};(function(){b.getArgs=function(a,b){var c=0,d=0,e={};while(d<b.length){var f=b[d],g=a[c];if(f.optional)g!==undefined&&f.check(g)?(e[f.name]=g,c++,d++):(f.defaultValue!==undefined&&(e[f.name]=f.defaultValue),d++);else{if(f.check&&!f.check(g))throw new Error("Invalid value for argument: "+f.name+" Value: "+g);e[f.name]=g,d++,c++}}return e},b.hasProperty=function(a){return function(b){return b&&b[a]!==undefined}},b.hasType=function(a){return function(b){return typeof b===a}},b.isCallback=function(){return function(a){return a&&a.apply}}})(),a.argspec=b;return a}typeof window==="undefined"&&(window={}),window.persistence=window&&window.persistence?window.persistence:createPersistence(),typeof exports!=="undefined"&&(exports.createPersistence=createPersistence,exports.persistence=persistence),typeof JSON==="undefined"&&(JSON={}),JSON.stringify||function(){function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i==="object"&&typeof i.toJSON==="function"&&(i=i.toJSON(a)),typeof rep==="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g;return e}if(rep&&typeof rep==="object"){f=rep.length;for(c=0;c<f;c+=1)d=rep[c],typeof d==="string"&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g;return e}}function quote(a){escapable.lastIndex=0;return escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b==="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(a){return a<10?"0"+a:a}typeof Date.prototype.toJSON!=="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!=="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c==="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c==="string"&&(indent=c);rep=b;if(b&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw new Error("JSON.stringify");return str("",{"":a})}),typeof JSON.parse!=="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e==="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})}();try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.sql={},persistence.store.sql.config=function(a,b){function g(b,c,d){var e=[];for(var f=3;f<arguments.length;f++)e.push(arguments[f]);a.asyncForEach(c,function(a,c){b.executeSql(a[0],a[1],c,function(a,b){console.log(b.message),c(a,b)})},function(a,b){b&&d?d(a,b):d&&d.apply(null,e)})}function f(b,c,d){var e=a.getMeta(b._type),f=a.typeMapper,h=[["DELETE FROM `"+b._type+"` WHERE id = "+f.outId(b.id),null]];for(var i in e.hasMany)if(e.hasMany.hasOwnProperty(i)&&e.hasMany[i].manyToMany){var j=e.hasMany[i].tableName;h.push(["DELETE FROM `"+j+"` WHERE `"+e.name+"_"+i+"` = "+f.outId(b.id),null])}g(c,h,d)}function e(b,c,d){var e=a.getMeta(b._type),f=a.typeMapper,h=[],i=[],j=[],k=[];if(b._new)for(var l in e.fields)e.fields.hasOwnProperty(l)&&(b._dirtyProperties[l]=!0);for(var l in b._dirtyProperties)if(b._dirtyProperties.hasOwnProperty(l)){h.push("`"+l+"`");var m=e.fields[l]||f.idType;i.push(f.entityValToDbVal(b._data[l],m)),j.push(f.outVar("?",m)),k.push("`"+l+"` = "+f.outVar("?",m))}var n=[];for(var l in e.hasMany)e.hasMany.hasOwnProperty(l)&&(n=n.concat(a.get(b,l).persistQueries()));g(c,n,function(){if(h.length===0)d&&d();else{b._dirtyProperties={};if(b._new){h.push("id"),i.push(f.entityIdToDbId(b.id)),j.push(f.outIdVar("?"));var a="INSERT INTO `"+b._type+"` ("+h.join(", ")+") VALUES ("+j.join(", ")+")";b._new=!1,c.executeSql(a,i,d,d)}else{var a="UPDATE `"+b._type+"` SET "+k.join(",")+" WHERE id = "+f.outId(b.id);c.executeSql(a,i,d,d)}}})}function d(b,c,d,e){e=e||"";if(b.trackedObjects[d[e+"id"]])return b.trackedObjects[d[e+"id"]];var f=a.typeMapper,g=a.getMeta(c),h=a.define(c);if(!d[e+"id"])return null;var i=new h(b,undefined,!0);i.id=f.dbValToEntityVal(d[e+"id"],f.idType),i._new=!1;for(var j in d)if(d.hasOwnProperty(j))if(j.substring(0,e.length)===e){var k=j.substring(e.length);k!="id"&&(i._data[k]=f.dbValToEntityVal(d[j],g.fields[k]||f.idType))}return i}var c=a.argspec;a.typeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(a){switch(a){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return a}},inVar:function(a,b){return a},outVar:function(a,b){return a},outId:function(a){return"'"+a+"'"},dbValToEntityVal:function(a,b){if(a===null||a===undefined)return a;switch(b){case"DATE"
:return new Date(parseInt(a,10)*1e3);case"BOOL":return a===1||a==="1";case"INT":return+a;case"BIGINT":return+a;case"JSON":return a?JSON.parse(a):a;default:return a}},entityValToDbVal:function(a,b){if(a===undefined||a===null)return null;if(b==="JSON"&&a)return JSON.stringify(a);if(a.id)return a.id;if(b==="BOOL")return a==="false"?0:a?1:0;if(b==="DATE"||a.getTime){a=new Date(a);return Math.round(a.getTime()/1e3)}return a},inIdVar:function(a){return this.inVar(a,this.idType)},outIdVar:function(a){return this.outVar(a,this.idType)},entityIdToDbId:function(a){return this.entityValToDbVal(a,this.idType)}},a.generatedTables={},a.schemaSync=function(d,e,f){var h=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:c.hasType("boolean")}]);d=h.tx,e=h.callback,f=h.emulate;if(d){var j=[],k,l,m,n,o=a.typeMapper,p=a.getEntityMeta();for(var q in p)if(p.hasOwnProperty(q)){k=p[q];if(!k.isMixin){l=[];for(var r in k.fields)k.fields.hasOwnProperty(r)&&l.push([r,k.fields[r]]);for(var s in k.hasOne)k.hasOne.hasOwnProperty(s)&&(m=k.hasOne[s].type.meta,l.push([s,o.idType]),j.push([b.createIndex(k.name,[s]),null]));for(var t=0;t<k.indexes.length;t++)j.push([b.createIndex(k.name,k.indexes[t].columns,k.indexes[t]),null])}for(var s in k.hasMany)if(k.hasMany.hasOwnProperty(s)&&k.hasMany[s].manyToMany){n=k.hasMany[s].tableName;if(!a.generatedTables[n]){var m=k.hasMany[s].type.meta,u=k.hasMany[s].inverseProperty;if(m.hasMany[u].type.meta!=k)continue;var v=k.name+"_"+s,w=m.name+"_"+u;j.push([b.createIndex(n,[v]),null]),j.push([b.createIndex(n,[w]),null]);var x=[[v,o.idType],[w,o.idType]];k.isMixin&&x.push([v+"_class",o.classNameType]),m.isMixin&&x.push([w+"_class",o.classNameType]),j.push([b.createTable(n,x),null]),a.generatedTables[n]=!0}}k.isMixin||(l.push(["id",o.idType,"PRIMARY KEY"]),a.generatedTables[k.name]=!0,j.push([b.createTable(k.name,l),null]))}var y=a.schemaSyncHooks;for(var t=0;t<y.length;t++)y[t](d);f?e(d):g(d,j,function(a,b){e(d,b)})}else{var i=this;this.transaction(function(a){i.schemaSync(a,e,f)})}},a.flush=function(b,d){var g=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:null}]);b=g.tx,d=g.callback;var h=this;if(b){var i=a.flushHooks;a.asyncForEach(i,function(a,c){a(h,b,c)},function(){var c=[];for(var g in h.trackedObjects)h.trackedObjects.hasOwnProperty(g)&&c.push(h.trackedObjects[g]);var i=[];for(var g in h.objectsToRemove)h.objectsToRemove.hasOwnProperty(g)&&(i.push(h.objectsToRemove[g]),delete h.trackedObjects[g]);h.objectsToRemove={};if(d)a.asyncParForEach(i,function(a,c){f(a,b,c)},function(f,g){if(g)return d(f,g);a.asyncParForEach(c,function(a,c){e(a,b,c)},d)});else{for(var j=0;j<c.length;j++)e(c[j],b);for(var j=0;j<i.length;j++)f(i[j],b)}})}else this.transaction(function(a){h.flush(a,d)})},a.reset=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=e.tx,d=e.callback;var f=this;b?this.schemaSync(b,function(){function h(b,c){f.clean(),a.generatedTables={},d&&d(b,c)}function g(){var a=c.pop();b.executeSql("DROP TABLE IF EXISTS `"+a+"`",null,function(){c.length>0?g():h()},h)}var c=[];for(var e in a.generatedTables)a.generatedTables.hasOwnProperty(e)&&c.push(e);c.length>0?g():h()},!0):f.transaction(function(a){f.reset(a,d)})},a.save=e,a.executeQueriesSeq=g,a.QueryCollection.prototype.persistQueries=function(){return[]};var h=a.QueryCollection.prototype.clone;a.QueryCollection.prototype.clone=function(a){var b=h.call(this,a);b._additionalJoinSqls=this._additionalJoinSqls.slice(0),b._additionalWhereSqls=this._additionalWhereSqls.slice(0),b._additionalGroupSqls=this._additionalGroupSqls.slice(0),b._manyToManyFetch=this._manyToManyFetch;return b};var i=a.QueryCollection.prototype.init;a.QueryCollection.prototype.init=function(a,b,c){i.call(this,a,b,c),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]};var j=a.QueryCollection.prototype.toUniqueString;a.QueryCollection.prototype.toUniqueString=function(){var a=j.call(this);a+="|JoinSQLs:";for(var b=0;b<this._additionalJoinSqls.length;b++)a+=this._additionalJoinSqls[b];a+="|WhereSQLs:";for(var b=0;b<this._additionalWhereSqls.length;b++)a+=this._additionalWhereSqls[b];a+="|GroupSQLs:";for(var b=0;b<this._additionalGroupSqls.length;b++)a+=this._additionalGroupSqls[b];this._manyToManyFetch&&(a+="|ManyToManyFetch:",a+=JSON.stringify(this._manyToManyFetch));return a},a.NullFilter.prototype.sql=function(a,b,c){return"1=1"},a.AndFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" AND "+this.right.sql(a,b,c)+")"},a.OrFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" OR "+this.right.sql(a,b,c)+")"},a.PropertyFilter.prototype.sql=function(b,c,d){var e=a.typeMapper,f=c?"`"+c+"`.":"",g=b.fields[this.property]||e.idType;if(this.operator==="="&&this.value===null)return f+"`"+this.property+"` IS NULL";if(this.operator==="!="&&this.value===null)return f+"`"+this.property+"` IS NOT NULL";if(this.operator==="in"){var h=this.value,i=[];for(var j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return h.length===0?"1 = 0":f+"`"+this.property+"` IN ("+i.join(", ")+")"}if(this.operator==="not in"){var h=this.value,i=[];for(var j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return h.length===0?"1 = 1":f+"`"+this.property+"` NOT IN ("+i.join(", ")+")"}var k=this.value;if(k===!0||k===!1)k=k?1:0;d.push(e.entityValToDbVal(k,g));return f+"`"+this.property+"` "+this.operator+" "+e.outVar("?",g)},a.DbQueryCollection.prototype.list=function(b,e){function m(a,b,c){var d=[k.inIdVar("`"+b+"`.id")+" AS "+c+"id"];for(var e in a.fields)a.fields.hasOwnProperty(e)&&d.push(k.inVar("`"+b+"`.`"+e+"`",a.fields[e])+" AS `"+c+e+"`");for(var e in a.hasOne)a.hasOne.hasOwnProperty(e)&&d.push(k.inIdVar("`"+b+"`.`"+e+"`")+" AS `"+c+e+"`");return d}var f=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=f.tx,e=f.callback;var g=this,h=this._session;if(b){var i=this._entityName,j=a.getMeta(i),k=a.typeMapper;if(j.isMixin){var l=[];a.asyncForEach(j.mixedIns,function(a,c){var d=g.clone();d._entityName=a.name,d.list(b,function(a){l=l.concat(a),c()})},function(){var b=new a.LocalQueryCollection(l);b._orderColumns=g._orderColumns,b._reverse=g._reverse,b.list(null,e)});return}var f=[],n=i+"_",o="root",p=m(j,o,n),q="",r=this._additionalWhereSqls.slice(0),s=this._manyToManyFetch;s&&(q+="LEFT JOIN `"+s.table+"` AS mtm ON mtm.`"+s.inverseProp+"` = `root`.`id` ",r.push("mtm.`"+s.prop+"` = "+k.outId(s.id))),q+=this._additionalJoinSqls.join(" ");for(var t=0;t<this._prefetchFields.length;t++){var u=this._prefetchFields[t],v=j.hasOne[u].type.meta;if(v.isMixin)throw new Error("cannot prefetch a mixin");var w=v.name+"_"+u+"_tbl";p=p.concat(m(v,w,u+"_")),q+="LEFT JOIN `"+v.name+"` AS `"+w+"` ON `"+w+"`.`id` = `"+o+"`.`"+u+"` "}var x="WHERE "+[this._filter.sql(j,o,f)].concat(r).join(" AND "),y="SELECT "+p.join(", ")+" FROM `"+i+"` AS `"+o+"` "+q+" "+x;this._additionalGroupSqls.length>0&&(y+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(y+=" ORDER BY "+this._orderColumns.map(function(a){return"`"+n+a[0]+"` "+(a[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(y+=" LIMIT "+this._limit),this._skip>0&&(y+=" OFFSET "+this._skip),h.flush(b,function(){b.executeSql(y,f,function(a){var b=[];g._reverse&&a.reverse();for(var c=0;c<a.length;c++){var f=a[c],k=d(h,i,f,n);for(var l=0;l<g._prefetchFields.length;l++){var m=g._prefetchFields[l],o=j.hasOne[m].type.meta;k._data_obj[m]=d(h,o.name,f,m+"_"),h.add(k._data_obj[m])}b.push(k),h.add(k)}e(b),g.triggerEvent("list",g,b)})})}else h.transaction(function(a){g.list(a,e)})},a.DbQueryCollection.prototype.destroyAll=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=e.tx,d=e.callback;var f=this,g=this._session;if(b){var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin){a.asyncForEach(i.mixedIns,function(a,c){var e=f.clone();e._entityName=a.name,e.destroyAll(b,d)},d);return}var k="",l=this._additionalWhereSqls.slice(0),m=this._manyToManyFetch;m&&(k+="LEFT JOIN `"+m.table+"` AS mtm ON mtm.`"+m.inverseProp+"` = `root`.`id` ",l.push("mtm.`"+m.prop+"` = "+j.outId(m.id))),k+=this._additionalJoinSqls.join(" ");var e=[],n="WHERE "+[this._filter.sql(i,null,e)].concat(l).join(" AND "),o="SELECT id FROM `"+h+"` "+k+" "+n,p="DELETE FROM `"+h+"` "+k+" "+n,q=e.slice(0);g.flush(b,function(){b.executeSql(o,e,function(a){for(var c=0;c<a.length;c++)delete g.trackedObjects[a[c].id],g.objectsRemoved.push({id:a[c].id,entity:h});f.triggerEvent("change",f),b.executeSql(p,q,d,d)},d)})}else g.transaction(function(a){f.destroyAll(a,d)})},a.DbQueryCollection.prototype.count=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=e.tx,d=e.callback;var f=this,g=this._session;b&&!b.executeSql&&(d=b,b=null);if(b){var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin){var k=0;a.asyncForEach(i.mixedIns,function(a,c){var d=f.clone();d._entityName=a.name,d.count(b,function(a){k+=a,c()})},function(){d(k)});return}var l="",m=this._additionalWhereSqls.slice(0),n=this._manyToManyFetch;n&&(l+="LEFT JOIN `"+n.table+"` AS mtm ON mtm.`"+n.inverseProp+"` = `root`.`id` ",m.push("mtm.`"+n.prop+"` = "+j.outId(n.id))),l+=this._additionalJoinSqls.join(" ");var e=[],o="WHERE "+[this._filter.sql(i,"root",e)].concat(m).join(" AND "),p="SELECT COUNT(*) AS cnt FROM `"+h+"` AS `root` "+l+" "+o;g.flush(b,function(){b.executeSql(p,e,function(a){d(parseInt(a[0].cnt,10))})})}else g.transaction(function(a){f.count(a,d)})},a.ManyToManyDbQueryCollection.prototype.persistQueries=function(){var b=[],c=a.getMeta(this._obj._type),d=c.hasMany[this._coll].type.meta,e=a.typeMapper,f=c.hasMany[this._coll],g=d.hasMany[f.inverseProperty],h=f.mixin?f.mixin.meta.name:c.name,i=g.mixin?g.mixin.meta.name:d.name;for(var j=0;j<this._localAdded.length;j++){var k=[h+"_"+this._coll,i+"_"+f.inverseProperty],l=[e.outIdVar("?"),e.outIdVar("?")],m=[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localAdded[j].id)];f.mixin&&(k.push(h+"_"+this._coll+"_class"),l.push("?"),m.push(c.name)),g.mixin&&(k.push(i+"_"+f.inverseProperty+"_class"),l.push("?"),m.push(d.name)),b.push(["INSERT INTO "+f.tableName+" (`"+k.join("`, `")+"`) VALUES ("+l.join(",")+")",m])}this._localAdded=[];for(var j=0;j<this._localRemoved.length;j++)b.push(["DELETE FROM  "+f.tableName+" WHERE `"+h+"_"+this._coll+"` = "+e.outIdVar("?")+" AND `"+i+"_"+f.inverseProperty+"` = "+e.outIdVar("?"),[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localRemoved[j].id)]]);this._localRemoved=[];return b}};try{exports.config=persistence.store.sql.config}catch(e){}try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.websql={},persistence.store.websql.config=function(a,b,c,d){var e=null;a.transaction=function(a){if(e)e.transaction(a);else throw new Error("No ongoing database connection, please connect first.")},a.db=a.db||{},a.db.implementation="unsupported",a.db.conn=null;if(typeof Titanium!=="undefined")a.db.implementation="titanium";else if(window&&window.openDatabase)a.db.implementation="html5";else if(window&&window.google&&google.gears)a.db.implementation="gears";else try{openDatabaseSync&&(a.db.implementation="html5-sync")}catch(f){}a.db.html5={},a.db.html5.connect=function(b,c,d){var e={},f=openDatabase(b,"1.0",c,d);e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5.transaction(c))})};return e},a.db.html5.transaction=function(b){var c={};c.executeSql=function(c,d,e,f){a.debug&&console.log(c,d),b.executeSql(c,d,function(a,b){if(e){var c=[];for(var d=0;d<b.rows.length;d++)c.push(b.rows.item(d));e(c)}},f)};return c},a.db.html5Sync={},a.db.html5Sync.connect=function(b,c,d){var e={},f=openDatabaseSync(b,"1.0",c,d);e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5Sync.transaction(c))})};return e},a.db.html5Sync.transaction=function(b){var c={};c.executeSql=function(c,d,e,f){d==null&&(d=[]),a.debug&&console.log(c,d);var g=b.executeSql(c,d);if(g)if(e){var h=[];for(var i=0;i<g.rows.length;i++)h.push(g.rows.item(i));e(h)}};return c},a.db.gears={},a.db.gears.connect=function(b){var c={},d=google.gears.factory.create("beta.database");d.open(b),c.transaction=function(b){b(a.db.gears.transaction(d))};return c},a.db.gears.transaction=function(b){var c={};c.executeSql=function(c,d,e,f){a.debug&&console.log(c,d);var g=b.execute(c,d);if(e){var h=[];while(g.isValidRow()){var i={};for(var j=0;j<g.fieldCount();j++)i[g.fieldName(j)]=g.field(j);h.push(i),g.next()}e(h)}};return c},a.db.titanium={},a.db.titanium.connect=function(b){var c={},d=Titanium.Database.open(b);c.transaction=function(b){b(a.db.titanium.transaction(d))};return c},a.db.titanium.transaction=function(b){var c={};c.executeSql=function(c,d,e,f){a.debug&&console.log(c,d);try{var g=[c];d&&(g=g.concat(d));var h=Function.apply.call(b.execute,b,g);if(h&&e){var i=[];while(h.isValidRow()){var j={};for(var k=0;k<h.fieldCount();k++)j[h.fieldName(k)]=h.field(k);i.push(j),h.next()}h.close(),e(i)}}catch(l){f&&f(null,l)}};return c},a.db.connect=function(b,c,d){if(a.db.implementation=="html5")return a.db.html5.connect(b,c,d);if(a.db.implementation=="html5-sync")return a.db.html5Sync.connect(b,c,d);if(a.db.implementation=="gears")return a.db.gears.connect(b);if(a.db.implementation=="titanium")return a.db.titanium.connect(b)},a.store.websql.sqliteDialect={createTable:function(b,c){var d=a.typeMapper,e="CREATE TABLE IF NOT EXISTS `"+b+"` (",f=[];for(var g=0;g<c.length;g++){var h=c[g];f.push("`"+h[0]+"` "+d.columnType(h[1])+(h[2]?" "+h[2]:""))}e+=f.join(", "),e+=")";return e},createIndex:function(a,b,c){c=c||{};return"CREATE "+(c.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+a+"__"+b.join("_")+"` ON `"+a+"` ("+b.map(function(a){return"`"+a+"`"}).join(", ")+")"}},a.store.sql.config(a,a.store.websql.sqliteDialect),e=a.db.connect(b,c,d);if(!e)throw new Error("No supported database found in this browser.")};try{exports.persistence=persistence}catch(e){}